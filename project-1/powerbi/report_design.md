# Power BI Report Design: Workforce Forecast Simulator

## Prerequisites

- Power BI Desktop installed (free download from Microsoft)
- PostgreSQL `wfm` database loaded (steps 1-5 from the README)
- Scenario results CSV available at `data/results/kpi_summary_60m.csv`

---

## Step 1: Connect to PostgreSQL

1. Open **Power BI Desktop**
2. Click **Home > Get Data > Database > PostgreSQL database**
3. Enter your connection details:
   - Server: `localhost`
   - Database: `wfm`
4. Click **OK**, then enter your PostgreSQL credentials (user: `postgres`, your password)
5. In the Navigator window, expand the `wfm` schema and select these four views:
   - `vw_contacts`
   - `vw_staffing`
   - `vw_forecast_latest`
   - `vw_scenario_kpis`
6. Also select these dimension tables:
   - `dim_channel`
   - `dim_queue`
   - `dim_time`
7. Click **Load**

### Loading scenario results from CSV

The scenario KPI summary is generated by the Python pipeline and not loaded into Postgres by default. To include it:

1. Click **Home > Get Data > Text/CSV**
2. Navigate to `project-1/data/results/kpi_summary_60m.csv`
3. Click **Load**
4. Rename the table to `scenario_kpis_csv` in the Fields pane (right-click > Rename)

---

## Step 2: Build the Data Model

1. Click the **Model** view icon (3rd icon on the left sidebar)
2. Power BI will auto-detect some relationships. Verify or create these:

### Create relationships

For each relationship below: right-click the fact table field, select **Manage relationships > New**, then configure:

| From (Many side)                   | To (One side)              | Cardinality  |
|------------------------------------|----------------------------|--------------|
| `vw_contacts[ts_start]`           | `dim_time[ts_start]`       | Many-to-One  |
| `vw_staffing[ts_start]`           | `dim_time[ts_start]`       | Many-to-One  |
| `vw_contacts[channel_name]`       | `dim_channel[channel_name]`| Many-to-One  |
| `vw_staffing[channel_name]`       | `dim_channel[channel_name]`| Many-to-One  |
| `vw_contacts[queue_name]`         | `dim_queue[queue_name]`    | Many-to-One  |
| `vw_staffing[queue_name]`         | `dim_queue[queue_name]`    | Many-to-One  |

3. For any relationship Power BI can't auto-create, drag the field from one table to the other in the Model view

### Set cross-filter direction

- For all relationships, set **Cross filter direction** to **Single** (from dimension to fact)
- This prevents ambiguous filter propagation between fact tables

---

## Step 3: Create DAX Measures

1. Click the **Report** view icon (1st icon on the left sidebar)
2. In the Fields pane, right-click `vw_contacts` > **New measure**
3. Enter each measure below one at a time. After typing the formula, press Enter, then right-click `vw_contacts` > **New measure** again for the next one.

### Volume measures (add to `vw_contacts`)

```DAX
Offered Contacts = SUM('vw_contacts'[offered_contacts])
```

```DAX
Handled Contacts = SUM('vw_contacts'[handled_contacts])
```

```DAX
Abandoned Contacts = SUM('vw_contacts'[abandoned_contacts])
```

```DAX
Abandon Rate = DIVIDE([Abandoned Contacts], [Offered Contacts])
```

### Service measures (add to `vw_contacts`)

```DAX
Avg Service Level = AVERAGE('vw_contacts'[service_level])
```

```DAX
Avg ASA Seconds = AVERAGE('vw_contacts'[asa_seconds])
```

### Staffing + Cost measures (right-click `vw_staffing` > New measure)

```DAX
Scheduled Agents = SUM('vw_staffing'[agents_scheduled])
```

```DAX
Available Agents = SUM('vw_staffing'[agents_available])
```

```DAX
Labor Cost =
SUMX(
    'vw_staffing',
    'vw_staffing'[agents_scheduled]
        * 'vw_staffing'[cost_per_hour]
        * ('vw_staffing'[interval_minutes] / 60.0)
)
```

### Format the measures

For each measure, click it in the Fields pane, then in the **Measure tools** tab at the top:
- `Abandon Rate`, `Avg Service Level`: set Format to **Percentage**
- `Labor Cost`: set Format to **Currency**
- `Avg ASA Seconds`: set Format to **Decimal Number**, 1 decimal place

---

## Step 4: Build Report Page 1 — Executive Summary

### Add KPI cards

1. Click an empty area of the canvas
2. From Visualizations pane, select the **Card** visual
3. Drag `Offered Contacts` measure into the **Fields** well
4. Resize and position in the top-left corner
5. Repeat to create cards for: `Labor Cost`, `Avg Service Level`, `Abandon Rate`
6. Arrange all four cards in a row across the top of the page

### Add the trend line chart

1. Click an empty area below the cards
2. Select **Line chart** from Visualizations
3. Configure the fields:
   - **X-axis**: `dim_time[date_key]`
   - **Y-axis**: `Offered Contacts` measure
4. To add a second line for Handled:
   - Drag `Handled Contacts` into the **Y-axis** well (below the first measure)
5. Resize to span the left half of the page

### Add channel breakdown bar chart

1. Click an empty area to the right of the line chart
2. Select **Clustered bar chart** from Visualizations
3. Configure:
   - **Y-axis**: `dim_channel[channel_name]`
   - **X-axis**: `Offered Contacts` measure
4. This shows volume split by voice, chat, email

### Add slicers for filtering

1. Select **Slicer** from Visualizations
2. Drag `dim_channel[channel_name]` into the **Field** well
3. In the slicer visual header, click the dropdown arrow and select **List** style
4. Position in the top-right corner
5. Create a second slicer for `dim_time[date_key]` and set it to **Between** date range style

### Rename the page

- Double-click the page tab at the bottom and type `Executive Summary`

---

## Step 5: Build Report Page 2 — Staffing Gap Heatmap

1. Click the **+** icon next to the page tab at the bottom to add a new page
2. Double-click the tab and rename to `Staffing Heatmap`

### Create the staffing gap measure (add to `vw_staffing`)

Right-click `vw_staffing` > **New measure**:

```DAX
Staffing Gap =
[Scheduled Agents] - [Available Agents]
```

### Build the heatmap matrix

1. Select **Matrix** from Visualizations
2. Configure:
   - **Rows**: `vw_staffing[dow]`
   - **Columns**: `vw_staffing[hour]`
   - **Values**: `Staffing Gap` measure
3. Click the **Format** pane (paint roller icon) in Visualizations
4. Expand **Cell elements > Background color**
   - Toggle it **On**
   - Click **fx** (conditional formatting)
   - Set **Format style** to **Gradient**
   - Minimum color: green (understaffed)
   - Maximum color: red (overstaffed)
   - Click **OK**
5. Expand **Row headers** and set the font size to 10

### Add a table for worst understaffed intervals

1. Click empty area below the heatmap
2. Select **Table** from Visualizations
3. Add columns: `vw_staffing[ts_start]`, `dim_channel[channel_name]`, `dim_queue[queue_name]`, `Scheduled Agents`, `Available Agents`, `Staffing Gap`
4. Click the column header `Staffing Gap` in the visual > sort ascending (smallest = most understaffed first)
5. In **Filters on this visual**, set `Staffing Gap` to **is less than 0** to show only understaffed intervals

---

## Step 6: Build Report Page 3 — Service Analysis

1. Add a new page, rename to `Service Analysis`

### Service level trend

1. Select **Line chart**
2. Configure:
   - **X-axis**: `dim_time[date_key]`
   - **Y-axis**: `Avg Service Level` measure
3. Add a **Constant line** via the Analytics pane:
   - Click the **Analytics** icon (magnifying glass) in Visualizations
   - Add a **Constant Line** at value `0.80`
   - Label it `Target SLA`

### ASA by channel and queue

1. Select **Clustered bar chart**
2. Configure:
   - **Y-axis**: `dim_queue[queue_name]`
   - **X-axis**: `Avg ASA Seconds` measure
   - **Legend**: `dim_channel[channel_name]`

### Service level by hour-of-day

1. Select **Column chart**
2. Configure:
   - **X-axis**: `vw_contacts[hour]`
   - **Y-axis**: `Avg Service Level` measure
   - **Legend**: `dim_channel[channel_name]`

---

## Step 7: Build Report Page 4 — Scenario Comparison

This page uses the `scenario_kpis_csv` table loaded from the Python pipeline output.

1. Add a new page, rename to `Scenario Comparison`

### Add scenario slicer

1. Select **Slicer** from Visualizations
2. Drag `scenario_kpis_csv[scenario_name]` into the **Field** well
3. Set to **List** style, position at the top of the page

### Scenario cost comparison bar chart

1. Select **Clustered bar chart**
2. Configure:
   - **Y-axis**: `scenario_kpis_csv[scenario_name]`
   - **X-axis**: `scenario_kpis_csv[planned_labor_cost]`, aggregation = **Sum**

### Scenario service level comparison

1. Select **Clustered bar chart**
2. Configure:
   - **Y-axis**: `scenario_kpis_csv[scenario_name]`
   - **X-axis**: `scenario_kpis_csv[avg_service_level]`, aggregation = **Average**

### Cost vs service scatter plot

1. Select **Scatter chart**
2. Configure:
   - **X-axis**: `scenario_kpis_csv[planned_labor_cost]`, aggregation = **Sum**
   - **Y-axis**: `scenario_kpis_csv[avg_service_level]`, aggregation = **Average**
   - **Details**: `scenario_kpis_csv[scenario_name]`
3. This plots each scenario as a dot showing the cost-service tradeoff

---

## Step 8: Add What-If Parameters (Optional)

What-If parameters let users interactively adjust scenario inputs.

1. Go to **Modeling > New Parameter > Numeric Range**
2. Create each parameter:

| Name               | Min  | Max  | Increment | Default |
|--------------------|------|------|-----------|---------|
| Demand Multiplier  | 0.70 | 1.30 | 0.05      | 1.00    |
| Shrinkage Delta    | -0.10| 0.10 | 0.01      | 0.00    |
| Wage Multiplier    | 0.80 | 1.30 | 0.05      | 1.00    |
| Staffing Buffer    | 0.00 | 0.25 | 0.01      | 0.08    |

3. For each parameter, check **Add slicer to this page**
4. Create a calculated measure that uses them:

```DAX
Adjusted Labor Cost =
[Labor Cost] * [Wage Multiplier Value] * (1 + [Staffing Buffer Value])
```

```DAX
Adjusted Demand =
[Offered Contacts] * [Demand Multiplier Value]
```

5. Use these adjusted measures in visuals to create interactive scenario modeling

---

## Step 9: Format and Publish

### Apply consistent formatting

1. Go to **View > Themes** and pick a theme (or use the default)
2. Add a **Text box** at the top of each page with the page title
3. Ensure all pages have the channel/date slicers synced:
   - Go to **View > Sync slicers**
   - Check the boxes to sync the channel and date slicers across all pages

### Save and publish

1. **File > Save As** — name the file `WFM_Forecast_Simulator.pbix`
2. To publish to Power BI Service:
   - Click **Home > Publish**
   - Select your workspace
   - Click **Select**
3. Configure a scheduled refresh in the Power BI Service if using the PostgreSQL connection

---

## Column Reference

These are the columns available in each view for building visuals:

| View / Table          | Columns                                                                                              |
|-----------------------|------------------------------------------------------------------------------------------------------|
| `vw_contacts`         | ts_start, interval_minutes, channel_name, queue_name, offered_contacts, handled_contacts, abandoned_contacts, aht_seconds, asa_seconds, service_level, sla_threshold_seconds, date_key, year, month, day, dow, hour, minute |
| `vw_staffing`         | ts_start, interval_minutes, channel_name, queue_name, agents_scheduled, agents_available, shrinkage_rate, cost_per_hour, date_key, year, month, day, dow, hour, minute |
| `vw_forecast_latest`  | ts_start, interval_minutes, channel_name, queue_name, model_name, forecast_offered, created_at       |
| `vw_scenario_kpis`    | scenario_name, interval_minutes, date_key, channel_name, required_agents_sum, scheduled_agents_sum, cost_total_sum, service_level_avg, sla_attainment_rate |
| `dim_channel`         | channel_id, channel_name, is_real_time                                                               |
| `dim_queue`           | queue_id, channel_name, queue_name                                                                   |
| `dim_time`            | time_id, ts_start, date_key, year, month, day, dow, hour, minute                                     |
